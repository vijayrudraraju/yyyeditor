<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>YESYESYES edit</title>
        <meta name="description" content="page for editing yesyesyes">
        <meta name="programmer" content="vijay rudraraju">

        <style type="text/css">
            
            html {
                margin: 0px;
                padding: 0px;
                border: 0px;
            }
            body {
                position: relative;
                top: 0px;
                margin: 0px;
                padding: 0px;
                border: 0px;
            }
            h1 {
                text-align: center;
                font-size: 120px;
                margin: 0px;
                padding: 0px;
                border: 0px;
            }
            h2 {
                text-align: center;
                font-size: 30px;
                margin: 0px;
                padding: 0px;
                border: 0px;
            }

            a {
                font-size: 30px;
            }

            fieldset div {
                padding: 10px;
            }
            textarea {
                width: 100%;
            }
            input[type=text] {
                width: 400px;
            }


            .bold {
                font-weight: bold;
            }

            .container {
                position: relative;
                width: 100%;
            }

            .tabs {
                width: 960px;
                height: 70px;
                margin: 20px;
            }
            .tab {
                padding: 20px;
                float: left;
            }

            .page-header {
                width: 960px;
                margin-top: 5px;
                margin-left: auto;
                margin-right: auto;
            }

            .section-header {
                width: 960px;
                height: 50px;
                margin-top: 30px;
                margin-bottom: 30px;
                margin-left: auto;
                margin-right: auto;
            }

            .section {
                margin: 20px;
            }
            .section-list {
                margin-top: 20px;
                margin-bottom: 20px;
            }

        </style>

        <script type="text/javascript" src="/_utils/script/json2.js"></script>
        <script type="text/javascript" src="script/jquery.js"></script>
        <script type="text/javascript" src="/_utils/script/jquery.couch.js"></script>
        <script type="text/javascript" src="script/underscore.js"></script>
        <script type="text/javascript" src="script/backbone.js"></script>
        <script type="text/javascript" src="script/backbone-couchdb.js"></script>
        <script src="script/jquery.form.js"></script>

        <script>
            $(function(){
                trigAll();

                Backbone.couch_connector.config.db_name = "yyy";
                Backbone.couch_connector.config.ddoc_name = "edit";

                window.PageModel= Backbone.Model.extend({
                    url: '/pages'
                }); 

                window.PageCollection = Backbone.Collection.extend({ 
                    model: PageModel,
                    db: {
                       view: "all" 
                    }
                });
                window.TextCollection = Backbone.Collection.extend({ 
                    model: PageModel,
                    db: {
                       view: "texts" 
                    }
                });
                window.ImagesCollection = Backbone.Collection.extend({ 
                    model: PageModel,
                    db: {
                       view: "images" 
                    }
                });

                window.Pages = new PageCollection;
                window.Texts = new TextCollection;
                window.Images = new ImagesCollection;

                window.NewAllView = Backbone.View.extend({
                    initialize: function() {
                        Pages.on('reset', this.onReset, this);
                        Pages.fetch({success: function() { console.log('all fetch success');}});
                    },
                    onReset: function(coll,resp) {
                        console.log('onReset all');

                        $('#all-articles-grid ul').html('');
                        Pages.each(this.addOne);
                    },
                    addOne: function(model) {
                        console.log(model);
                        $('#all-articles-grid ul').append(
                        '<li>'+model.get('title')+'<br/>'+model.get('author')+'</li>'
                        );
                    },
                });
                window.NewAll = new NewAllView;

                window.NewTextView = Backbone.View.extend({
                    selectedId: 0,
                    events: {
                        "click .text-edit-button": "editOne"
                    },
                    initialize: function() {
                        Texts.on('reset', this.onReset, this);
                        Texts.fetch({success: function() { console.log('text fetch success');}});
                    },
                    onReset: function(coll,resp) {
                        console.log('onReset text');

                        $('#text-articles-grid ul').html('');
                        Texts.each(this.addOne);
                    },
                    editOne: function(ev) {
                        console.log('editOne ',ev,ev.target.id);

                        var stringArray = ev.target.id.split('-');
                        var model = Texts.getByCid(stringArray[2]);
                        console.log(model);

                        this.selectedId = model.id;

                        $('#text-new-form').hide();
                        $('#text-edit-form').show();
                        $('#text-articles-grid').hide();
                        
                        $('#text-edit-title').val(model.get('title'));
                        $('#text-edit-author').val(model.get('author'));
                        $('#text-edit-main').val(model.get('text'));
                        $('#text-edit-form :hidden').val(model.get('_rev'));
                    },
                    addOne: function(model) {
                        console.log(model);
                        $('#text-articles-grid ul').append(
                        '<li>'+model.get('title')+'<br/>'+model.get('author')+'<br/><button type="button" class="text-edit-button" id="text-edit-'+model.cid+'">edit</button><button type="button" class="text-view-button" id="text-view-'+model.cid+'">view</button></li>'
                        );
                    },
                    saveNewToServer: function() {
                        console.log('saveNewToServer text');

                        Texts.add({
                            title:$('#text-title').val(),
                            author:$('#text-author').val(),
                            text:$('#text-main').val()
                        });

                        Texts.at(Texts.length-1).save({},{
                            success: function() { 
                                console.log('save success ' + Texts.at(Texts.length-1).id + ' ' + Texts.at(Texts.length-1).cid); 
                                Texts.fetch({success: function() { console.log('post save fetch success');}});
                            }
                        });
                    },
                    saveOldToServer: function() {
                        console.log('saveOldToServer text');

                        Texts.get(this.selectedId).set({
                            title:$('#text-edit-title').val(),
                            author:$('#text-edit-author').val(),
                            text:$('#text-edit-main').val()
                        });

                        Texts.get(this.selectedId).save({},{
                            success: function(model) { 
                                console.log('text re-save success ' + model.id + ' ' + model.cid); 
                                Texts.fetch({success: function() { console.log('text post re-save fetch success');}});
                            }
                        });
                    }
                });
                window.NewText = new NewTextView({ el: $('#text-section') });
                $('#text-new-form').submit(function(e) {
                    e.preventDefault(); 
                    window.NewText.saveNewToServer(); 
                });
                $('#text-edit-form').submit(function(e) {
                    e.preventDefault(); 
                    window.NewText.saveOldToServer(); 
                });


                window.NewImageView = Backbone.View.extend({
                    initialize: function() {
                        $('#main-images').change(this.fileChange);
                        Images.on('reset', this.onReset, this);
                        Images.fetch({success: function() { console.log('images fetch success');}});
                    },
                    onReset: function(coll,resp) {
                        console.log('onReset images');

                        $('#images-articles-grid ul').html('');
                        Images.each(this.addOne);
                    },
                    addOne: function(model) {
                        console.log(model);
                        $('#images-articles-grid ul').append(
                        '<li>'+model.get('title')+'<br/>'+model.get('author')+'<br/><button type="button" class="images-edit-button" id="images-edit-'+model.cid+'">edit</button><button type="button" class="images-view-button" id="images-view-'+model.cid+'">view</button></li>'
                        );
                    },
                    fileChange: function(ev) {
                        var fileNames = [];
                        var data = {};
                        var i = 0;
                        $('#new-images-form :file').each(function() {
                            data[this.name] = this.value;
                            var stringArray = this.value.split("\\");
                            fileNames[i] = stringArray[stringArray.length-1];
                            i++;
                        });
                        if (!data._attachments || data._attachments.length == 0) {
                            alert('Please some images from your computer for the author');
                            return;
                        }
                        for (var i=0;i<fileNames.length;i++) {
                            $('#image-files').append('<li>'+fileNames[i]+'</li>');
                        }
                    },
                    saveToServer: function() {
                        console.log('saveToServer images');

                        Images.add({
                            title:$('#images-title').val(),
                            author:$('#images-author').val(),
                            images:$('#main-images').val(),
                            filenames:fileNames
                        });

                        Images.at(Images.length-1).save({},{
                            success: function() { 
                                console.log('save success ' + Images.at(Images.length-1).id + ' ' + Images.at(Images.length-1).cid); 
                                $('#new-images-form :hidden').val(Images.at(Images.length-1).get('_rev'));
                                $('#new-images-form').ajaxSubmit({
                                    url: '/yyy/'+Images.at(Images.length-1).id,
                                    type: 'post',
                                    dataType: 'json',
                                    success: function(data) {
                                        console.log('banner logo upload success!');
                                        console.log(data);
                                    },
                                    error: function(data) {
                                        console.log('banner logo upload error!');
                                    }
                                });
                                Images.fetch({success: function() { console.log('post save fetch success');}});
                            }
                        });
                    }
                });
                window.NewImage = new NewImageView;
                $('#new-images-form').submit(function(e) {
                    e.preventDefault(); 
                    window.NewImage.saveToServer(); 
                });


            });

            function trigAll() {
                $('.section-header h2').html('all');
                $('#all-link').addClass('bold');

                $('#all-section').show();
                $('#text-section').hide();
                $('#images-section').hide();
                $('#videos-section').hide();
                $('#music-section').hide();

                $('#text-link').removeClass('bold');
                $('#images-link').removeClass('bold');
                $('#videos-link').removeClass('bold');
                $('#music-link').removeClass('bold');
            }
            function trigText() {
                $('.section-header h2').html('text');
                $('#text-link').addClass('bold');

                $('#all-section').hide();
                $('#text-section').show();
                $('#images-section').hide();
                $('#videos-section').hide();
                $('#music-section').hide();

                $('#text-new-form').show();
                $('#text-edit-form').hide();

                $('#all-link').removeClass('bold');
                $('#images-link').removeClass('bold');
                $('#videos-link').removeClass('bold');
                $('#music-link').removeClass('bold');
            }
            function trigImages() {
                $('.section-header h2').html('images');
                $('#images-link').addClass('bold');

                $('#all-section').hide();
                $('#text-section').hide();
                $('#images-section').show();
                $('#videos-section').hide();
                $('#music-section').hide();

                $('#all-link').removeClass('bold');
                $('#text-link').removeClass('bold');
                $('#videos-link').removeClass('bold');
                $('#music-link').removeClass('bold');
            }
            function trigVideos() {
                $('.section-header h2').html('videos');
                $('#videos-link').addClass('bold');

                $('#all-section').hide();
                $('#text-section').hide();
                $('#images-section').hide();
                $('#videos-section').show();
                $('#music-section').hide();

                $('#all-link').removeClass('bold');
                $('#text-link').removeClass('bold');
                $('#images-link').removeClass('bold');
                $('#music-link').removeClass('bold');
            }
            function trigMusic() {
                $('.section-header h2').html('music');
                $('#music-link').addClass('bold');

                $('#all-section').hide();
                $('#text-section').hide();
                $('#images-section').hide();
                $('#videos-section').hide();
                $('#music-section').show();

                $('#all-link').removeClass('bold');
                $('#text-link').removeClass('bold');
                $('#images-link').removeClass('bold');
                $('#videos-link').removeClass('bold');
            }

        </script>

        <script type="text/template" id="text-edit-template">
        </script>

    </head>

    <body>

        <div class="container">

            <div class="content">

                <div class="page-header">
                    <h1>YESYESYES</h1>
                    <h2>San Francisco Arts and Culture</h2>
                </div>

                <div class="tabs">
                    <div class="tab"><a id="all-link" href="javascript:trigAll()">all</a></div>
                    <div class="tab"><a id="text-link" href="javascript:trigText()">text</a></div>
                    <div class="tab"><a id="images-link" href="javascript:trigImages()">images</a></div>
                    <div class="tab"><a id="videos-link" href="javascript:trigVideos()">videos</a></div>
                    <div class="tab"><a id="music-link" href="javascript:trigMusic()">music</a></div>
                </div>

                <div class="section-header">
                    <h2>all</h2>
                </div>

                <div>



                    <div id="all-section" class="section">

                        <div id="all-articles-grid" class="section-list">
                            <ul>
                            </ul>
                        </div>

                    </div>



                    <div id="text-section" class="section">

                        <form id="text-new-form" action="" method="post" class="">
                            <fieldset>
                                <legend>new text form</legend>

                                <div>
                                    <label for="text-title">new text title</label>
                                    <div>
                                        <input id="text-title" type="text" placeholder="text title" name="title"/>
                                    </div>
                                </div>

                                <div>
                                    <label for="text-author">new text author</label>
                                    <div>
                                        <input id="text-author" type="text" placeholder="text author" name="author"/>
                                    </div>
                                </div>

                                <div>
                                    <label for="text-main">new main text</label>
                                    <div>
                                        <textarea id="text-main" placeholder="main text" name="text" rows="20"></textarea>
                                    </div>
                                </div>

                                <div>
                                    <div>
                                        <input type="submit" value="create new article"/>
                                    </div>
                                </div>

                            </fieldset>
                        </form>

                        <form id="text-edit-form" action="" method="post" class="">
                            <fieldset>
                                <legend>edit text form</legend>

                                <div>
                                    <label for="text-edit-title">edit text title</label>
                                    <div>
                                        <input id="text-edit-title" type="text" placeholder="text title" name="title"/>
                                    </div>
                                </div>

                                <div>
                                    <label for="text-edit-author">edit text author</label>
                                    <div>
                                        <input id="text-edit-author" type="text" placeholder="text author" name="author"/>
                                    </div>
                                </div>

                                <div>
                                    <label for="text-edit-main">edit main text</label>
                                    <div>
                                        <textarea id="text-edit-main" placeholder="main text" name="text" rows="20"></textarea>
                                    </div>
                                </div>

                                <div>
                                    <div>
                                        <input type="submit" value="edit old article"/>
                                        <input type="hidden" name="_rev"/>
                                    </div>
                                </div>

                            </fieldset>
                        </form>

                        <div id="text-articles-grid" class="section-list">
                            <ul>
                            </ul>
                        </div>

                    </div>



                    <div id="images-section" class="section">

                        <form id="new-images-form" action="" method="post" class="">
                            <fieldset>
                                <legend>new images form</legend>

                                <div>
                                    <label for="images-title">new images title</label>
                                    <div>
                                        <input id="images-title" type="text" placeholder="images title"/>
                                    </div>
                                </div>

                                <div>
                                    <label for="images-author">new images author</label>
                                    <div>
                                        <input id="images-author" type="text" placeholder="text author"/>
                                    </div>
                                </div>

                                <div>
                                    <label for="main-images">new main images</label>
                                    <div>
                                        <input type="file" id="main-images" name="_attachments" multiple=""/>
                                        <ul id="image-files">
                                        </ul>
                                    </div>
                                </div>

                                <div>
                                    <div>
                                        <input type="submit" value="create new article"/>
                                        <input type="hidden" name="_rev"/>
                                    </div>
                                </div>

                            </fieldset>
                        </form>

                        <div id="images-articles-grid" class="section-list">
                            <ul>
                            </ul>
                        </div>

                    </div>



                    <div id="videos-section">

                    </div>



                    <div id="music-section">

                    </div>



                </div>

            </div><!-- /content-->

        </div> <!-- /container -->

    </body>
</html>

